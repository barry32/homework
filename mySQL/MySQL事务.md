#### MySQL事务

1. 一条 SQL 语句在 MySQL 中是如何执行的？

一条查询语句：

连接器(校验登录权限) ----> 查询缓存命中直接返回

未命中则 -----> 分析器（词法分析、语法分析校验SQL syntax语法）----> 优化器（采用何种索引）---> 执行器（调用存储引擎接口）

一条更新语句：

连接器(校验登录权限) -----> 分析器（词法分析、语法分析校验SQL syntax语法）----> 优化器（采用何种索引）---> 执行器（调用存储引擎接口）

* 开启事务
* 根据where 条件当前读，添加X锁
* 在Log Buffer中记录Undo Log、Redo Log
* 更新Buffer Pool内存页
* 提交事务前 Redo Log等日志落盘
* 释放X锁

2. 事务四大特性 ACID

* 原子性：事务内的数据库操作要么全部执行要么全部不执行。当数据库执行正常时，但不满足业务上的原子性要求，可以支持回滚。
* 一致性：事务开始前和结束后满足数据完整性，满足数据中的完整性约束：主键、外键、唯一键、check约束。还包含业务层面的规则。比如转账事务的前后总金额一致。
* 隔离性：两个事务之间的操作相互隔离，互相不影响。
* 持久性：事务一旦提交，对数据的修改是永久的，对于一般的数据库故障如断电，也不影响数据的保存。

3. 事务隔离级别

   读未提交、读已提交、可重复读、串行化

4. 事务会产生的并发问题

* 脏读：一个事务读到另外一个事务的未提交的数据。事务隔离级别为读已提交可以解决该问题。
* 不可重复读：事务A读取数据，当事务B提交后，事务A再次读取该记录发现不是之前的数值。事务隔离级别为可重复读可以解决该问题。
* 幻读：事务A读取范围的数据集，当事务B提交后，事务A再次读取时发现多出了数据行记录。事务隔离级别为串行化可以解决该问题。
* 写偏差：当前属于业务层面的问题。读取一些数据进行逻辑计算操作后准备写入的时候，发现不符合前提条件。比如：事务A查询会员等级 为黄金并计算积分，用于更新积分表。事务B查询积分表发现当前用户的积分处于黄金等级的积分以下恢复期，按照积分等级需要降级为白银，并提交事务。事务A 提交事务时，当前计算积分出现业务上错误。事务隔离级别设置为串行化可以解决该问题。
* 丢失更新问题：并发事务中 A事务和B事务同时读取一个数据并进行更新，A事务更新后的数值被B事务更新后的数值修改覆盖。比如: 事务A 查询数据为100， 事务B查询数据为100。事务A将数值更新为110 并提交。事务B将数值更新为90并提交。此时可以使用悲观锁解决该问题。

5. 事务的安全性、性能与隔离级别的关系

   安全性、隔离级别：读未提交<读已提交<可重复读<串行化

   性能：读未提交>读已提交>可重复读>串行化